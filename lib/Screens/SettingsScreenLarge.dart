import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../Widgets/AccessDeniedWidget.dart';
import '../Widgets/Authorization.dart'; // For AuthService
import '../Widgets/Permissions.dart'; // For permission constants
import '../Widgets/BranchFilterService.dart';
import '../main.dart'; // UserScopeService

// Child Screens
import 'AnalyticsScreen.dart';
import 'BranchManagement.dart';
import 'CouponsScreen.dart';
import 'OrderHistory.dart';
import 'RestaurantTimingScreen.dart';
import 'StaffManagementScreen.dart'; // Explicit import
import 'TableManagement.dart';

class SettingsScreenLarge extends StatefulWidget {
  const SettingsScreenLarge({super.key});

  @override
  State<SettingsScreenLarge> createState() => _SettingsScreenLargeState();
}

class _SettingsScreenLargeState extends State<SettingsScreenLarge> {
  // Navigation State
  String _selectedSection = 'timings'; // Default section

  @override
  Widget build(BuildContext context) {
    final userScope = context.watch<UserScopeService>();
    final authService = context.read<AuthService>();
    final branchFilter = context.watch<BranchFilterService>();

    return Scaffold(
      backgroundColor: Colors.grey[50], // Neutral background
      body: Row(
        children: [
          // LEFT SIDEBAR (Navigation)
          Container(
            width: 300,
            decoration: BoxDecoration(
              color: Colors.white,
              border: Border(right: BorderSide(color: Colors.grey[200]!)),
            ),
            child: Column(
              children: [
                _buildProfileHeader(userScope, branchFilter),
                Expanded(
                  child: ListView(
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    children: [
                      _buildSectionHeader('Administration'),
                      if (userScope.isSuperAdmin)
                        _NavItem(
                          icon: Icons.access_time_rounded,
                          label: 'Timings',
                          id: 'timings',
                          isSelected: _selectedSection == 'timings',
                          onTap: () =>
                              setState(() => _selectedSection = 'timings'),
                        ),
                      if (userScope.isSuperAdmin ||
                          userScope.role.toLowerCase().contains('branch'))
                        _NavItem(
                          icon: Icons.history_edu_rounded,
                          label: 'Order History',
                          id: 'history',
                          isSelected: _selectedSection == 'history',
                          onTap: () =>
                              setState(() => _selectedSection = 'history'),
                        ),
                      if (userScope.isSuperAdmin) ...[
                        _NavItem(
                          icon: Icons.people_alt,
                          label: 'Staff',
                          id: 'staff',
                          isSelected: _selectedSection == 'staff',
                          onTap: () =>
                              setState(() => _selectedSection = 'staff'),
                        ),
                        _NavItem(
                          icon: Icons.business_outlined,
                          label: 'Branches',
                          id: 'branches',
                          isSelected: _selectedSection == 'branches',
                          onTap: () =>
                              setState(() => _selectedSection = 'branches'),
                        ),
                        _NavItem(
                          icon: Icons.analytics_outlined,
                          label: 'Analytics',
                          id: 'analytics',
                          isSelected: _selectedSection == 'analytics',
                          onTap: () =>
                              setState(() => _selectedSection = 'analytics'),
                        ),
                      ],
                      if (userScope.can(Permissions.canManageCoupons))
                        _NavItem(
                          icon: Icons.card_giftcard_rounded,
                          label: 'Coupons',
                          id: 'coupons',
                          isSelected: _selectedSection == 'coupons',
                          onTap: () =>
                              setState(() => _selectedSection = 'coupons'),
                        ),
                      if (userScope.isSuperAdmin ||
                          userScope.role == 'branch_admin')
                        _NavItem(
                          icon: Icons.table_restaurant_rounded,
                          label: 'Tables',
                          id: 'tables',
                          isSelected: _selectedSection == 'tables',
                          onTap: () =>
                              setState(() => _selectedSection = 'tables'),
                        ),
                      const SizedBox(height: 24),
                      _buildSectionHeader('Account'),
                      _NavItem(
                        icon: Icons.logout_rounded,
                        label: 'Sign Out',
                        id: 'logout',
                        isSelected: false,
                        iconColor: Colors.red,
                        textColor: Colors.red,
                        onTap: () => _showLogoutDialog(context, authService),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // RIGHT CONTENT PANE
          Expanded(
            child: Container(
              color: Colors.grey[50], // Match scaffold
              child: ClipRect(
                // Ensure content doesn't bleed
                child: _buildContent(userScope),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildContent(UserScopeService userScope) {
    // We use a switching mechanism.
    // Ideally, we using IndexedStack for state preservation, but some screens utilize 'initState' to load data,
    // so creating them fresh might be safer for data consistency unless we want to cache.
    // Let's use a simple Switch for now.

    switch (_selectedSection) {
      case 'timings':
        return const RestaurantTimingScreen();
      case 'history':
        return const OrderHistoryScreen();
      // Placeholder for StaffManagementScreen check
      case 'staff':
        return const StaffManagementScreen();
      case 'branches':
        return const BranchManagementScreen();
      case 'analytics':
        return const AnalyticsScreen();
      case 'coupons':
        return const CouponManagementScreen();
      case 'tables':
        return const TableManagementScreen();
      default:
        return const Center(child: Text('Select a section'));
    }
  }

  Widget _buildProfileHeader(
      UserScopeService userScope, BranchFilterService branchFilter) {
    // Reusing logic from SettingsScreen for visuals
    final identifier = userScope.userEmail.isNotEmpty
        ? userScope.userEmail
        : userScope.userIdentifier;
    final initials =
        identifier.isNotEmpty ? identifier.substring(0, 2).toUpperCase() : 'U';

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        border: Border(bottom: BorderSide(color: Colors.grey[100]!)),
      ),
      child: Row(
        children: [
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              color: Colors.deepPurple,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Center(
                child: Text(initials,
                    style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 18))),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(identifier,
                    style: const TextStyle(
                        fontWeight: FontWeight.bold, fontSize: 14),
                    overflow: TextOverflow.ellipsis),
                Text(userScope.role.toUpperCase(),
                    style: const TextStyle(
                        color: Colors.grey,
                        fontSize: 10,
                        fontWeight: FontWeight.bold)),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(24, 8, 24, 8),
      child: Text(
        title.toUpperCase(),
        style: TextStyle(
          color: Colors.grey[500],
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.0,
        ),
      ),
    );
  }

  void _showLogoutDialog(BuildContext context, AuthService authService) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Sign Out'),
        content: const Text('Are you sure you want to sign out?'),
        actions: [
          TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Cancel')),
          TextButton(
              onPressed: () {
                Navigator.pop(context);
                authService.signOut();
              },
              style: TextButton.styleFrom(foregroundColor: Colors.red),
              child: const Text('Sign Out')),
        ],
      ),
    );
  }
}

class _NavItem extends StatelessWidget {
  final IconData icon;
  final String label;
  final String id;
  final bool isSelected;
  final VoidCallback onTap;
  final Color? iconColor;
  final Color? textColor;

  const _NavItem({
    required this.icon,
    required this.label,
    required this.id,
    required this.isSelected,
    required this.onTap,
    this.iconColor,
    this.textColor,
  });

  @override
  Widget build(BuildContext context) {
    final effectiveIconColor =
        iconColor ?? (isSelected ? Colors.deepPurple : Colors.grey[600]);
    final effectiveTextColor =
        textColor ?? (isSelected ? Colors.deepPurple : Colors.black87);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 2),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(8),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: isSelected ? Colors.deepPurple.shade50 : Colors.transparent,
            borderRadius: BorderRadius.circular(8),
          ),
          child: Row(
            children: [
              Icon(icon, size: 20, color: effectiveIconColor),
              const SizedBox(width: 12),
              Text(
                label,
                style: TextStyle(
                  color: effectiveTextColor,
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
